#!/bin/bash

# Script to move all .txt files from a directory tree to a separate location
# Usage: ./move_txt_files.sh [source_directory] [destination_directory]
# Primarily used on ExploitDB files, get those by running:
#      git clone git@gitlab.com:exploit-database/exploitdb.git


# Set default values
SOURCE_DIR="${1:-.}"  # Default to current directory if not specified
DEST_DIR="${2:-./txt_files}"  # Default destination directory

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Validate source directory
if [ ! -d "$SOURCE_DIR" ]; then
    print_error "Source directory '$SOURCE_DIR' does not exist!"
    exit 1
fi

# Create destination directory if it doesn't exist
if [ ! -d "$DEST_DIR" ]; then
    print_info "Creating destination directory: $DEST_DIR"
    mkdir -p "$DEST_DIR"
    if [ $? -ne 0 ]; then
        print_error "Failed to create destination directory!"
        exit 1
    fi
fi

# Convert to absolute paths to avoid issues
SOURCE_DIR=$(realpath "$SOURCE_DIR")
DEST_DIR=$(realpath "$DEST_DIR")

print_info "Source directory: $SOURCE_DIR"
print_info "Destination directory: $DEST_DIR"

# Check if destination is inside source (to prevent moving files to subdirectory)
if [[ "$DEST_DIR" == "$SOURCE_DIR"* ]]; then
    print_error "Destination directory cannot be inside the source directory!"
    exit 1
fi

# Initialize counters
moved_count=0
error_count=0

print_info "Searching for .txt files..."

# Find and move all .txt files
while IFS= read -r -d '' file; do
    # Get just the filename without path
    filename=$(basename "$file")
    dest_file="$DEST_DIR/$filename"
    
    # Handle filename conflicts by adding a number suffix
    counter=1
    original_dest="$dest_file"
    while [ -e "$dest_file" ]; do
        name_without_ext="${filename%.txt}"
        dest_file="$DEST_DIR/${name_without_ext}_${counter}.txt"
        ((counter++))
    done
    
    # Move the file
    if mv "$file" "$dest_file"; then
        print_info "Moved: $file -> $dest_file"
        ((moved_count++))
    else
        print_error "Failed to move: $file"
        ((error_count++))
    fi
    
done < <(find "$SOURCE_DIR" -name "*.txt" -type f -print0)

# Print summary
echo
print_info "=== SUMMARY ==="
print_info "Files moved successfully: $moved_count"
if [ $error_count -gt 0 ]; then
    print_error "Files failed to move: $error_count"
fi

if [ $moved_count -eq 0 ]; then
    print_warning "No .txt files found in the source directory."
else
    print_info "All .txt files have been moved to: $DEST_DIR"
fi
